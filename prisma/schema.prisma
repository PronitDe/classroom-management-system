// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  TEACHER
  SPOC
  ADMIN
  STUDENT
}

enum RoomType {
  LECTURE_HALL
  LAB
  SEMINAR_ROOM
  FACULTY_ROOM
}

enum BookingStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
  CANCELLED
}

enum IssueStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

model User {
  id           String   @id @default(uuid())
  name         String
  email        String   @unique
  passwordHash String
  role         Role
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  bookings          Booking[]
  attendanceRecords Attendance[]
  issueReports      IssueReport[]

  @@index([email])
  @@index([role])
}

model Room {
  id       String   @id @default(uuid())
  building String // AU4, AU5, AU6, AU7
  roomNo   String
  capacity Int
  type     RoomType
  isActive Boolean  @default(true)
  remarks  String?

  bookings          Booking[]
  attendanceRecords Attendance[]
  issueReports      IssueReport[]

  @@unique([building, roomNo])
  @@index([building])
  @@index([isActive])
}

model Booking {
  id        String        @id @default(uuid())
  teacherId String
  roomId    String
  date      DateTime
  slot      String // e.g., "9:00-10:30"
  status    BookingStatus @default(PENDING)
  remarks   String?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  teacher          User         @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  room             Room         @relation(fields: [roomId], references: [id], onDelete: Cascade)
  attendanceRecord Attendance?

  @@index([teacherId])
  @@index([roomId])
  @@index([date])
  @@index([status])
}

model Attendance {
  id        String   @id @default(uuid())
  bookingId String   @unique
  teacherId String
  roomId    String
  date      DateTime
  slot      String
  total     Int
  present   Int
  remarks   String?
  createdAt DateTime @default(now())

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  teacher User    @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  room    Room    @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([teacherId])
  @@index([roomId])
  @@index([date])
}

model IssueReport {
  id        String      @id @default(uuid())
  teacherId String
  roomId    String
  message   String
  status    IssueStatus @default(OPEN)
  response  String?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  teacher User @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  room    Room @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([teacherId])
  @@index([roomId])
  @@index([status])
}
